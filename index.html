<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Go Go Gadget</title>
  <!-- Speels lettertype -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <!-- JsBarcode Library voor barcode genereren -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    /* Algemene styling met een vrolijke achtergrond en speels lettertype */
    body {
      font-family: 'Comic Neue', cursive, sans-serif;
      background: linear-gradient(to bottom right, #fceabb, #f8b500);
      color: #333;
      padding: 20px;
      margin: 0;
    }
    /* Main wrapper met 3 kolommen: Overzicht, Hoofdinterface en rechterkolom (Acties + Voorraad) */
    .main-wrapper {
      display: flex;
      justify-content: center;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    /* Rechterkolom: Acties en Voorraad gestapeld */
    .side-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 400px;
      width: 100%;
    }
    /* Bij kleinere schermen onder elkaar */
    @media (max-width: 768px) {
      .main-wrapper {
        flex-direction: column;
        align-items: center;
      }
      /* Zorg dat containers op smalle schermen de volle breedte nemen */
      #OverzichtContainer, #mainContainer, .side-right {
        max-width: 100%;
        width: 100%;
      }
    }
    /* Containers styling */
    #mainContainer,
    #OverzichtContainer,
    #buttonContainer,
    #inventoryDisplayContainer {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.15);
      margin-bottom: 20px;
    }
    #mainContainer {
      max-width: 500px;
      width: 100%;
    }
    /* Overzicht kan iets smaller */
    #OverzichtContainer {
      max-width: 400px;
      width: 100%;
    }
    h1, h2, h3 {
      color: #ff6b81;
      margin-top: 0;
    }
    /* Styling voor de vierkante categorieknoppen */
    .product {
      margin: 10px;
      padding: 15px;
      border: 2px solid #f8b500;
      font-size: 18px;
      cursor: pointer;
      background-color: #fff;
      border-radius: 15px;
      transition: all 0.3s ease;
      width: 150px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .product:hover, .product.selected {
      background-color: #ffeaa7;
      transform: scale(1.05);
    }
    button {
      margin-top: 20px;
      padding: 15px;
      font-size: 18px;
      border-radius: 15px;
      border: none;
      background-color: #ff6b81;
      color: #fff;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #ff4757;
      transform: scale(1.03);
    }
    button:active {
      background-color: #ff2e2e;
    }
    .delete-btn {
      background-color: #ff7979;
    }
    input, select {
      width: 95%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    table, th, td {
      border: 1px solid #f8b500;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #ff6b81;
      color: #fff;
    }
    .admin-section {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .admin-section button {
      margin-top: 10px;
      width: auto;
    }
    .admin-section div {
      margin-top: 10px;
    }
    /* Notificatie styling */
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 1000;
      display: none;
    }
    #notification.show {
      opacity: 1;
    }
    #notification.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #notification.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    /* Modal styling voor het overzicht van recente aankopen */
    #modal, #barcodeModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      z-index: 1001;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    /* Zorg dat de sluitknop bovenaan komt */
    #modal button, #barcodeModal button {
      margin-bottom: 10px;
      width: auto;
    }
  </style>
</head>
<body>
  <!-- Notificatie-element -->
  <div id="notification"></div>

  <!-- Main wrapper met 3 kolommen: Overzicht, Hoofdinterface en rechterkolom (Acties + Voorraad) -->
  <div class="main-wrapper">
    <!-- Overzicht (linkerkant) -->
    <div class="container" id="OverzichtContainer">
      <h2>Overzicht</h2>
      <div id="Overzicht"></div>
    </div>

    <!-- Hoofdinterface (midden) -->
    <div id="mainContainer">
      <h1>Inspector Gadget's Koelekast</h1>
      <p>
        Voer je naam in en kies één of meerdere categorieën (klik meerdere keren voor meerdere stuks; rechtermuisklik om een klik ongedaan te maken):
      </p>
      <!-- Enkel één invoerveld met datalist (zowel voor nieuwe als bestaande namen) -->
      <input type="text" id="username" placeholder="Jouw naam" list="usernames" autofocus />
      <datalist id="usernames"></datalist>
      
      <!-- Barcode Scanner Invoer -->
      <div id="barcodeScannerContainer">
        <label for="barcodeInput">Scan Barcode:</label>
        <input type="text" id="barcodeInput" placeholder="Scan hier je barcode" autofocus />
      </div>
      
      <!-- Container voor de vier categorie-knoppen -->
      <div id="products" style="display: flex; flex-wrap: wrap;"></div>
    </div>

    <!-- Rechterkolom: Acties en Voorraad -->
    <div class="side-right">
      <!-- Acties -->
      <div class="container" id="buttonContainer">
        <h2>Acties</h2>
        <button onclick="confirmPurchase()">Bevestig aankoop</button>
        <button onclick="removePurchase()" class="delete-btn">Verwijder aankoop</button>
        <button onclick="showPurchases()" style="background-color:#007bff;">Bekijk recente aankopen</button>
        <!-- Nieuwe knop op het hoofdscherm om de barcode lijst te tonen -->
        <button onclick="showBarcodeList()" style="background-color:#28a745;">Bekijk barcode lijst</button>
        <button onclick="showAdminOverview()" style="background-color:#f44e90;">Admin Overzicht</button>
      </div>
      <!-- Voorraad -->
      <div class="container" id="inventoryDisplayContainer">
        <h2>Voorraad</h2>
        <div id="inventoryDisplay"></div>
      </div>
    </div>
  </div>
  
  <!-- Modal voor het overzicht van recente aankopen -->
  <div id="modal">
    <button onclick="closeModal()">Sluiten</button>
    <div id="modalContent"></div>
  </div>
  
  <!-- Nieuw modaal venster voor Barcode Lijst (hoofdscherm) -->
  <div id="barcodeModal">
    <button onclick="closeBarcodeModal()">Sluiten</button>
    <div id="barcodeListModal"></div>
  </div>
  
  <!-- Admin overzicht (volledig scherm) -->
  <div class="container" id="adminView" style="display: none;">
    <h1>Admin Overzicht</h1>
    <div id="adminContent"></div>
    <button onclick="removeAllInfo()" style="background-color:#ff7979;">Verwijder alle info</button>
    <button onclick="hideAdminOverview()" style="background-color:#6c757d;">Terug</button>

    <div class="admin-section">
      <h2>Productbeheer</h2>
      <button onclick="toggleProductManagement()">Producten beheren</button>
      <div id="adminProductManagement" style="display: none;">
        <input type="text" id="productName" placeholder="Productnaam" />
        <input type="number" id="productPrice" placeholder="Prijs" step="0.01" />
        <button id="addProductButton" onclick="addOrUpdateProduct()">Voeg product toe</button>
        <div id="productList"></div>
      </div>
    </div>
    
    <!-- Voorraad Overzicht in admin paneel -->
    <div class="admin-section">
      <h2>Voorraad Overzicht</h2>
      <div id="inventoryOverview"></div>
      <h3>Voeg nieuw voorraad item toe</h3>
      <label for="inventoryCategory">Categorie:</label>
      <select id="inventoryCategory"></select>
      <input type="text" id="inventoryItem" placeholder="Item naam" />
      <button onclick="addInventoryItem()">Voeg item toe</button>
    </div>
    
    <!-- Admin-sectie: Product Barcode Lijst -->
    <div class="admin-section">
      <h2>Product Barcode Lijst</h2>
      <div id="barcodeList"></div>
    </div>
    
    <!-- Admin-sectie: User Barcode Lijst -->
    <div class="admin-section">
      <h2>User Barcode Lijst</h2>
      <div id="userBarcodeList"></div>
    </div>
    
  </div>
  
  <script>
    /**********************
     * NOTIFICATIE FUNCTIE
     **********************/
    function showNotification(message, type = "success") {
      const notif = document.getElementById("notification");
      notif.innerText = message;
      notif.className = "";
      notif.classList.add("show", type);
      notif.style.display = "block";
      setTimeout(() => {
        notif.classList.remove("show");
        notif.style.display = "none";
      }, 3000);
    }
    
    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }
    
    function closeBarcodeModal() {
      document.getElementById("barcodeModal").style.display = "none";
    }
    
    /**********************
     * INITIALISATIE
     **********************/
    // Lees of initialiseer productcategorieën (met barcode) uit localStorage
    let productCategories = JSON.parse(localStorage.getItem("productCategories"));
    if (!productCategories) {
      productCategories = [
        { key: "€0.50 snacks", label: "€0.50 snacks", defaultPrice: 0.50, barcode: "123456789012" },
        { key: "€0.75 kinderBueno", label: "€0.75 kinderBueno", defaultPrice: 0.75, barcode: "234567890123" },
        { key: "€0.80 drinken", label: "€0.80 drinken", defaultPrice: 0.80, barcode: "345678901234" },
        { key: "€1.10 overige", label: "€1.10 overige", defaultPrice: 1.10, barcode: "456789012345" }
      ];
      localStorage.setItem("productCategories", JSON.stringify(productCategories));
    }
    
    // Lees of initialiseer voorraad (inventory)
    let inventory = JSON.parse(localStorage.getItem("inventory"));
    if (!inventory) {
      inventory = {
        snacks: ["Lion", "Twix", "Mars", "Snickers", "Kitkat"],
        drinken: ["Coca-Cola", "Coca-Cola Zero", "Coca-Cola Cherry", "Coca-Cola Vanille", "7UP"],
        kinderBueno: ["Kinder Bueno"],
        overige: ["Arizona", "Dr Pepper"]
      };
      localStorage.setItem("inventory", JSON.stringify(inventory));
    }
    
    // Lees of initialiseer user barcodes (naam -> barcode) uit localStorage
    let userBarcodes = JSON.parse(localStorage.getItem("userBarcodes"));
    if (!userBarcodes) {
      userBarcodes = {};
      localStorage.setItem("userBarcodes", JSON.stringify(userBarcodes));
    }
    
    // Globale variabele voor de geselecteerde gebruiker
    let currentUser = "";
    
    // Zodra de gebruiker het naamveld verlaat, genereer een barcode indien nodig
    document.getElementById("username").addEventListener("blur", function() {
      let username = this.value.trim();
      if (username && !userBarcodes[username]) {
        let newUserBarcode = Math.floor(100000000000 + Math.random() * 900000000000).toString();
        userBarcodes[username] = newUserBarcode;
        localStorage.setItem("userBarcodes", JSON.stringify(userBarcodes));
        updateUserBarcodeList();
      }
      if (username) {
        currentUser = username;
      }
    });
    
    // Pas de globale klik-listener aan zodat als je op het "username"-veld klikt,
    // de focus niet automatisch wordt teruggezet naar het barcodeveld.
    document.addEventListener("click", function(e) {
      if (e.target.id === "username" || e.target.id === "barcodeInput") return;
      document.getElementById("barcodeInput").focus();
    });
    
    let selectedCounts = {};
    
    /**********************
     * FUNCTIES VOOR DE SHOP
     **********************/
    function loadProducts() {
      const container = document.getElementById("products");
      container.innerHTML = "";
      productCategories.forEach(category => {
        let div = document.createElement("div");
        div.className = "product";
        div.dataset.key = category.key;
        div.innerText = category.label;
        
        // Linkerklik: verhoog teller
        div.addEventListener("click", function(e) {
          let count = selectedCounts[category.key] || 0;
          count++;
          selectedCounts[category.key] = count;
          div.innerText = category.label + (count > 1 ? " (" + count + ")" : "");
          div.classList.add("selected");
        });
        
        // Rechterklik: verlaag teller en voorkom contextmenu
        div.addEventListener("contextmenu", function(e) {
          e.preventDefault();
          let count = selectedCounts[category.key] || 0;
          if (count > 0) {
            count--;
            if (count === 0) {
              delete selectedCounts[category.key];
              div.innerText = category.label;
              div.classList.remove("selected");
            } else {
              selectedCounts[category.key] = count;
              div.innerText = category.label + " (" + count + ")";
            }
          }
        });
        
        container.appendChild(div);
      });
    }
    
    function confirmPurchase() {
      let username = document.getElementById("username").value.trim();
      if (!username) {
        showNotification("Vul je naam in!", "error");
        return;
      }
      if (!userBarcodes[username]) {
        let newUserBarcode = Math.floor(100000000000 + Math.random() * 900000000000).toString();
        userBarcodes[username] = newUserBarcode;
        localStorage.setItem("userBarcodes", JSON.stringify(userBarcodes));
        updateUserBarcodeList();
      }
      currentUser = username;
      
      if (Object.keys(selectedCounts).length === 0) {
        showNotification("Kies minstens één categorie!", "error");
        return;
      }
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      if (!purchases[username]) {
        purchases[username] = [];
      }
      for (let [catKey, count] of Object.entries(selectedCounts)) {
        let category = productCategories.find(c => c.key === catKey);
        for (let i = 0; i < count; i++) {
          let purchase = { 
            name: category.label, 
            price: category.defaultPrice,
            category: category.key,
            timestamp: new Date().toISOString() 
          };
          purchases[username].push(purchase);
        }
      }
      localStorage.setItem("purchases", JSON.stringify(purchases));
      updateDatalist();
      updateOverzicht();
      showNotification(`${username}, je hebt je aankoop bevestigd.`, "success");
      selectedCounts = {};
      document.querySelectorAll(".product").forEach(el => {
        let key = el.dataset.key;
        let cat = productCategories.find(c => c.key === key);
        if (cat) { el.innerText = cat.label; }
        el.classList.remove("selected");
      });
    }
    
    function removePurchase() {
      let username = document.getElementById("username").value.trim();
      if (!username) {
        showNotification("Vul je naam in om je aankopen te bekijken.", "error");
        return;
      }
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      if (!purchases[username] || purchases[username].length === 0) {
        showNotification("Je hebt nog geen aankopen om te verwijderen.", "error");
        return;
      }
      let categoryCounts = {};
      purchases[username].forEach(purchase => {
        categoryCounts[purchase.name] = (categoryCounts[purchase.name] || 0) + 1;
      });
      let message = "Welke aankoop wil je verwijderen? Voer het nummer in:\n";
      let categoryList = Object.keys(categoryCounts);
      categoryList.forEach((catName, index) => {
        message += `${index + 1}. ${catName} (${categoryCounts[catName]}x)\n`;
      });
      let input = prompt(message);
      let selectedIndex = parseInt(input) - 1;
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= categoryList.length) {
        showNotification("Ongeldige invoer.", "error");
        return;
      }
      let selectedCategoryName = categoryList[selectedIndex];
      let idx = purchases[username].findIndex(p => p.name === selectedCategoryName);
      if (idx === -1) {
        showNotification("Categorie niet gevonden.", "error");
        return;
      }
      let removed = purchases[username].splice(idx, 1);
      localStorage.setItem("purchases", JSON.stringify(purchases));
      updateOverzicht();
      showNotification(`Er is 1x ${removed[0].name} verwijderd.`, "success");
    }
    
    function adminRemoveProduct(username) {
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      if (!purchases[username] || purchases[username].length === 0) {
        showNotification("Deze gebruiker heeft geen aankopen.", "error");
        return;
      }
      let categoryCounts = {};
      purchases[username].forEach(purchase => {
        categoryCounts[purchase.name] = (categoryCounts[purchase.name] || 0) + 1;
      });
      let message = `Welke aankoop wil je verwijderen voor ${username}? Voer het nummer in:\n`;
      let categoryList = Object.keys(categoryCounts);
      categoryList.forEach((catName, index) => {
        message += `${index + 1}. ${catName} (${categoryCounts[catName]}x)\n`;
      });
      let input = prompt(message);
      let selectedIndex = parseInt(input) - 1;
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= categoryList.length) {
        showNotification("Ongeldige invoer.", "error");
        return;
      }
      let selectedCategoryName = categoryList[selectedIndex];
      let idx = purchases[username].findIndex(p => p.name === selectedCategoryName);
      if (idx === -1) {
        showNotification("Categorie niet gevonden.", "error");
        return;
      }
      let removed = purchases[username].splice(idx, 1);
      localStorage.setItem("purchases", JSON.stringify(purchases));
      updateOverzicht();
      updateAdminContent();
      showNotification(`Er is 1x ${removed[0].name} verwijderd voor ${username}.`, "success");
    }
    
    function adminRemoveAllGoods(username) {
      if (confirm(`Weet je zeker dat je alle aankopen van ${username} wilt verwijderen?`)) {
        let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
        if (!purchases[username] || purchases[username].length === 0) {
          showNotification("Deze gebruiker heeft geen aankopen.", "error");
          return;
        }
        purchases[username] = [];
        localStorage.setItem("purchases", JSON.stringify(purchases));
        updateOverzicht();
        updateAdminContent();
        showNotification(`Alle aankopen van ${username} zijn verwijderd.`, "success");
      }
    }
    
    function showPurchases() {
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      let allPurchases = [];
      for (let user in purchases) {
        purchases[user].forEach(p => {
          allPurchases.push({ ...p, user });
        });
      }
      allPurchases.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      let html = "<table><tr><th>Tijd</th><th>Gebruiker</th><th>Product</th><th>Prijs</th></tr>";
      allPurchases.forEach(p => {
        html += `<tr>
                    <td>${new Date(p.timestamp).toLocaleString()}</td>
                    <td>${p.user}</td>
                    <td>${p.name}</td>
                    <td>€${p.price.toFixed(2)}</td>
                 </tr>`;
      });
      html += "</table>";
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("modal").style.display = "block";
    }
    
    function updateDatalist() {
      let datalist = document.getElementById("usernames");
      datalist.innerHTML = "";
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      for (let user in purchases) {
        let option = document.createElement("option");
        option.value = user;
        datalist.appendChild(option);
      }
    }
    
    function updateOverzicht() {
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      let users = Object.keys(purchases).map(user => {
        let totalSpent = purchases[user].reduce((sum, p) => sum + p.price, 0);
        return { user, totalSpent };
      });
      users.sort((a, b) => b.totalSpent - a.totalSpent);
      
      let html = "<table>";
      html += "<tr><th>Gebruiker</th>";
      productCategories.forEach(product => {
        html += `<th>${product.label}</th>`;
      });
      html += "<th>Totaal (€)</th></tr>";
      
      users.forEach(({user, totalSpent}) => {
        html += `<tr><td>${user}</td>`;
        productCategories.forEach(product => {
          let count = purchases[user].filter(p => p.category === product.key).length;
          html += `<td>${count > 0 ? product.label + " x" + count : "-"}</td>`;
        });
        html += `<td>€${totalSpent.toFixed(2)}</td>`;
        html += "</tr>";
      });
      html += "</table>";
      document.getElementById("Overzicht").innerHTML = html;
    }
    
    function updateAdminContent() {
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      let users = Object.keys(purchases).map(user => {
        let totalSpent = purchases[user].reduce((sum, p) => sum + p.price, 0);
        return { user, totalSpent };
      });
      users.sort((a, b) => b.totalSpent - a.totalSpent);
      
      let html = "<table>";
      html += "<tr><th>Gebruiker</th>";
      productCategories.forEach(product => {
        html += `<th>${product.label}</th>`;
      });
      html += "<th>Totaal</th><th>Acties</th></tr>";
      
      users.forEach(({user, totalSpent}) => {
        html += `<tr><td>${user}</td>`;
        productCategories.forEach(product => {
          let count = purchases[user].filter(p => p.category === product.key).length;
          html += `<td>${count > 0 ? product.label + " x" + count : "-"}</td>`;
        });
        html += `<td>€${totalSpent.toFixed(2)}</td>
                 <td>
                   <button onclick="removeUser('${user}')">Verwijder gebruiker</button><br/>
                   <button onclick="adminRemoveProduct('${user}')">Verwijder 1 aankoop</button><br/>
                   <button onclick="adminRemoveAllGoods('${user}')">Verwijder alle aankopen</button>
                 </td>
                 </tr>`;
      });
      html += "</table>";
      document.getElementById("adminContent").innerHTML = html;
    }
    
    function removeUser(username) {
      if (confirm(`Weet je zeker dat je alle aankopen van ${username} wilt verwijderen?`)) {
        let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
        delete purchases[username];
        localStorage.setItem("purchases", JSON.stringify(purchases));
        updateDatalist();
        updateOverzicht();
        updateAdminContent();
        showNotification(`Alle aankopen van ${username} zijn verwijderd.`, "success");
      }
    }
    
    function showAdminOverview() {
      let code = prompt("Voer de admin code in:");
      if (code !== "admin123") {
        showNotification("Onjuiste code!", "error");
        return;
      }
      document.getElementById("mainContainer").style.display = "none";
      document.querySelector(".main-wrapper").style.display = "none";
      document.getElementById("adminView").style.display = "block";
      updateAdminContent();
      updateInventoryOverview();
      updateBarcodeList();
      updateUserBarcodeList();
    }
    
    function hideAdminOverview() {
      document.getElementById("adminView").style.display = "none";
      document.getElementById("mainContainer").style.display = "block";
      document.querySelector(".main-wrapper").style.display = "flex";
    }
    
    function removeAllInfo() {
      let confirmText = prompt("Weet je zeker dat je ALLE informatie wilt verwijderen? Dit kan niet ongedaan gemaakt worden. Typ 'VERWIJDER' om te bevestigen.");
      if (confirmText === "VERWIJDER") {
        localStorage.removeItem("purchases");
        updateDatalist();
        updateOverzicht();
        updateAdminContent();
        showNotification("Alle informatie is verwijderd.", "success");
      } else {
        showNotification("Verwijderen geannuleerd.", "error");
      }
    }
    
    /**********************
     * ADMIN: PRODUCTBEHEER
     **********************/
    let editingProductIndex = -1;
    
    function toggleProductManagement() {
      let container = document.getElementById("adminProductManagement");
      container.style.display = (container.style.display === "none" || container.style.display === "") ? "block" : "none";
      updateAdminProductList();
    }
    
    function updateAdminProductList() {
      let container = document.getElementById("productList");
      container.innerHTML = "";
      productCategories.forEach((product, index) => {
        let div = document.createElement("div");
        div.innerHTML = `${product.label} - €${product.defaultPrice.toFixed(2)} - Barcode: ${product.barcode}
          <button onclick="editProduct(${index})">Bewerk</button>
          <button onclick="deleteProduct(${index})">Verwijder</button>`;
        container.appendChild(div);
      });
    }
    
    function editProduct(index) {
      editingProductIndex = index;
      const product = productCategories[index];
      document.getElementById("productName").value = product.label;
      document.getElementById("productPrice").value = product.defaultPrice;
      document.getElementById("addProductButton").textContent = "Update product";
    }
    
    function addOrUpdateProduct() {
      let nameInput = document.getElementById("productName");
      let priceInput = document.getElementById("productPrice");
      let name = nameInput.value.trim();
      let price = parseFloat(priceInput.value);
      if (!name || isNaN(price)) {
        showNotification("Vul zowel een productnaam als een geldige prijs in.", "error");
        return;
      }
      if (editingProductIndex === -1) {
        let newBarcode = Math.floor(100000000000 + Math.random() * 900000000000).toString();
        productCategories.push({ 
          key: name.toLowerCase().replace(/\s/g, ''), 
          label: name, 
          defaultPrice: price,
          barcode: newBarcode
        });
        showNotification("Product toegevoegd.", "success");
      } else {
        let newKey = name.toLowerCase().replace(/\s/g, '');
        productCategories[editingProductIndex].label = name;
        productCategories[editingProductIndex].defaultPrice = price;
        productCategories[editingProductIndex].key = newKey;
        showNotification("Product bijgewerkt.", "success");
        editingProductIndex = -1;
        document.getElementById("addProductButton").textContent = "Voeg product toe";
      }
      nameInput.value = "";
      priceInput.value = "";
      localStorage.setItem("productCategories", JSON.stringify(productCategories));
      updateAdminProductList();
      loadProducts();
      updateOverzicht();
      updateAdminContent();
      updateInventoryDisplay();
      updateBarcodeList();
    }
    
    function deleteProduct(index) {
      if (confirm("Weet je zeker dat je dit product wilt verwijderen?")) {
        productCategories.splice(index, 1);
        showNotification("Product verwijderd.", "success");
        localStorage.setItem("productCategories", JSON.stringify(productCategories));
        updateAdminProductList();
        loadProducts();
        updateOverzicht();
        updateAdminContent();
        updateInventoryDisplay();
        updateBarcodeList();
      }
    }
    
    /**********************
     * ADMIN: VOORRAAD OVERZICHT
     **********************/
    function updateInventoryOverview() {
      let inventory = JSON.parse(localStorage.getItem("inventory"));
      let html = "<table><tr><th>Categorie</th><th>Voorraad</th><th>Acties</th></tr>";
      productCategories.forEach(cat => {
        let catKey = cat.key;
        let items = (inventory[catKey] || []).join(", ");
        html += `<tr>
                    <td>${cat.label}</td>
                    <td>${items || "Geen items"}</td>
                    <td><button onclick="editInventoryCategory('${catKey}')">Bewerk</button></td>
                 </tr>`;
      });
      html += "</table>";
      document.getElementById("inventoryOverview").innerHTML = html;
      updateInventoryCategoryDropdown();
    }
    
    function updateInventoryCategoryDropdown() {
      let select = document.getElementById("inventoryCategory");
      select.innerHTML = "";
      productCategories.forEach(cat => {
        let option = document.createElement("option");
        option.value = cat.key;
        option.text = cat.label;
        select.appendChild(option);
      });
    }
    
    function editInventoryCategory(catKey) {
      let inventory = JSON.parse(localStorage.getItem("inventory"));
      let currentItems = inventory[catKey] || [];
      let newItems = prompt("Pas de voorraad aan (scheid items met een komma):", currentItems.join(", "));
      if (newItems !== null) {
        let updatedItems = newItems.split(",").map(item => item.trim()).filter(item => item !== "");
        inventory[catKey] = updatedItems;
        localStorage.setItem("inventory", JSON.stringify(inventory));
        updateInventoryOverview();
        updateInventoryDisplay();
        showNotification("Voorraad bijgewerkt.", "success");
      }
    }
    
    function addInventoryItem() {
      let category = document.getElementById("inventoryCategory").value;
      let itemName = document.getElementById("inventoryItem").value.trim();
      if (!itemName) {
        showNotification("Voer een item naam in.", "error");
        return;
      }
      let inventory = JSON.parse(localStorage.getItem("inventory"));
      if (!inventory[category]) {
        inventory[category] = [];
      }
      inventory[category].push(itemName);
      localStorage.setItem("inventory", JSON.stringify(inventory));
      document.getElementById("inventoryItem").value = "";
      updateInventoryOverview();
      updateInventoryDisplay();
      showNotification("Item toegevoegd.", "success");
    }
    
    /**********************
     * VOORRAAD WEERGAVE OP HOOFDSCHERM
     **********************/
    function updateInventoryDisplay() {
      let inventory = JSON.parse(localStorage.getItem("inventory"));
      let html = "<table><tr><th>Categorie</th><th>Items</th></tr>";
      productCategories.forEach(cat => {
        let catKey = cat.key;
        let items = (inventory[catKey] || []).join(", ");
        html += `<tr>
                   <td>${cat.label}</td>
                   <td>${items || "Geen items"}</td>
                 </tr>`;
      });
      html += "</table>";
      document.getElementById("inventoryDisplay").innerHTML = html;
    }
    
    /**********************
     * BARCODE SCANNER FUNCTIES
     **********************/
    document.getElementById("barcodeInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        handleBarcodeScan();
      }
    });
    
    function handleBarcodeScan() {
      let scannedValue = document.getElementById("barcodeInput").value.trim();
      if (!scannedValue) return;
      
      // Eerst: controleer of de barcode bij een gebruiker hoort
      let foundUser = null;
      for (const [name, code] of Object.entries(userBarcodes)) {
        if (code === scannedValue) {
          foundUser = name;
          break;
        }
      }
      if (foundUser) {
        currentUser = foundUser;
        document.getElementById("username").value = foundUser;
        showNotification(`Gebruiker geselecteerd: ${foundUser}`, "success");
        document.getElementById("barcodeInput").value = "";
        return;
      }
      
      if (!currentUser) {
        showNotification("Geen gebruiker geselecteerd. Scan eerst de gebruikersbarcode.", "error");
        document.getElementById("barcodeInput").value = "";
        return;
      }
      
      let product = productCategories.find(p => p.barcode === scannedValue);
      if (product) {
        let productDivs = document.querySelectorAll(".product");
        productDivs.forEach(div => {
          if (div.dataset.key === product.key) {
            div.click();
            showNotification(`${product.label} toegevoegd via barcode.`, "success");
          }
        });
      } else {
        showNotification("Barcode niet herkend.", "error");
      }
      document.getElementById("barcodeInput").value = "";
      document.getElementById("barcodeInput").focus();
    }
    
    /**********************
     * NIEUWE FUNCTIES: BARCODE LIJST OP HOOFDSCHERM
     **********************/
    function updateBarcodeListModal() {
      let container = document.getElementById("barcodeListModal");
      container.innerHTML = "";
      productCategories.forEach(product => {
        let wrapper = document.createElement("div");
        wrapper.style.marginBottom = "20px";
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "barcode-modal-" + product.key;
        wrapper.appendChild(svg);
        let caption = document.createElement("div");
        caption.textContent = product.label + " (Barcode: " + product.barcode + ")";
        wrapper.appendChild(caption);
        container.appendChild(wrapper);
        JsBarcode(svg, product.barcode, { format: "CODE128", displayValue: true, width: 2, height: 50 });
      });
    }
    
    function showBarcodeList() {
      updateBarcodeListModal();
      document.getElementById("barcodeModal").style.display = "block";
      document.getElementById("barcodeModal").scrollTop = 0;
    }
    
    /**********************
     * UPDATE ADMIN EN DATALIST
     **********************/
    function updateUserBarcodeList() {
      let container = document.getElementById("userBarcodeList");
      if (!container) return;
      container.innerHTML = "";
      for (const [user, code] of Object.entries(userBarcodes)) {
        let wrapper = document.createElement("div");
        wrapper.style.marginBottom = "20px";
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "user-barcode-" + user.replace(/\s/g, '');
        wrapper.appendChild(svg);
        let caption = document.createElement("div");
        caption.textContent = user + " (Barcode: " + code + ")";
        wrapper.appendChild(caption);
        container.appendChild(wrapper);
        JsBarcode(svg, code, { format: "CODE128", displayValue: true, width: 2, height: 50 });
      }
    }
    
    function updateDatalist() {
      let datalist = document.getElementById("usernames");
      datalist.innerHTML = "";
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      for (let user in purchases) {
        let option = document.createElement("option");
        option.value = user;
        datalist.appendChild(option);
      }
    }
    
    function updateOverzicht() {
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      let users = Object.keys(purchases).map(user => {
        let totalSpent = purchases[user].reduce((sum, p) => sum + p.price, 0);
        return { user, totalSpent };
      });
      users.sort((a, b) => b.totalSpent - a.totalSpent);
      
      let html = "<table>";
      html += "<tr><th>Gebruiker</th>";
      productCategories.forEach(product => {
        html += `<th>${product.label}</th>`;
      });
      html += "<th>Totaal (€)</th></tr>";
      
      users.forEach(({user, totalSpent}) => {
        html += `<tr><td>${user}</td>`;
        productCategories.forEach(product => {
          let count = purchases[user].filter(p => p.category === product.key).length;
          html += `<td>${count > 0 ? product.label + " x" + count : "-"}</td>`;
        });
        html += `<td>€${totalSpent.toFixed(2)}</td>`;
        html += "</tr>";
      });
      html += "</table>";
      document.getElementById("Overzicht").innerHTML = html;
    }
    
    function updateAdminContent() {
      let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
      let users = Object.keys(purchases).map(user => {
        let totalSpent = purchases[user].reduce((sum, p) => sum + p.price, 0);
        return { user, totalSpent };
      });
      users.sort((a, b) => b.totalSpent - a.totalSpent);
      
      let html = "<table>";
      html += "<tr><th>Gebruiker</th>";
      productCategories.forEach(product => {
        html += `<th>${product.label}</th>`;
      });
      html += "<th>Totaal</th><th>Acties</th></tr>";
      
      users.forEach(({user, totalSpent}) => {
        html += `<tr><td>${user}</td>`;
        productCategories.forEach(product => {
          let count = purchases[user].filter(p => p.category === product.key).length;
          html += `<td>${count > 0 ? product.label + " x" + count : "-"}</td>`;
        });
        html += `<td>€${totalSpent.toFixed(2)}</td>
                 <td>
                   <button onclick="removeUser('${user}')">Verwijder gebruiker</button><br/>
                   <button onclick="adminRemoveProduct('${user}')">Verwijder 1 aankoop</button><br/>
                   <button onclick="adminRemoveAllGoods('${user}')">Verwijder alle aankopen</button>
                 </td>
                 </tr>`;
      });
      html += "</table>";
      document.getElementById("adminContent").innerHTML = html;
    }
    
    function removeUser(username) {
      if (confirm(`Weet je zeker dat je alle aankopen van ${username} wilt verwijderen?`)) {
        let purchases = JSON.parse(localStorage.getItem("purchases")) || {};
        delete purchases[username];
        localStorage.setItem("purchases", JSON.stringify(purchases));
        updateDatalist();
        updateOverzicht();
        updateAdminContent();
        showNotification(`Alle aankopen van ${username} zijn verwijderd.`, "success");
      }
    }
    
    function showAdminOverview() {
      let code = prompt("Voer de admin code in:");
      if (code !== "admin123") {
        showNotification("Onjuiste code!", "error");
        return;
      }
      document.getElementById("mainContainer").style.display = "none";
      document.querySelector(".main-wrapper").style.display = "none";
      document.getElementById("adminView").style.display = "block";
      updateAdminContent();
      updateInventoryOverview();
      updateBarcodeList();
      updateUserBarcodeList();
    }
    
    function hideAdminOverview() {
      document.getElementById("adminView").style.display = "none";
      document.getElementById("mainContainer").style.display = "block";
      document.querySelector(".main-wrapper").style.display = "flex";
    }
    
    function removeAllInfo() {
      let confirmText = prompt("Weet je zeker dat je ALLE informatie wilt verwijderen? Dit kan niet ongedaan gemaakt worden. Typ 'VERWIJDER' om te bevestigen.");
      if (confirmText === "VERWIJDER") {
        localStorage.removeItem("purchases");
        updateDatalist();
        updateOverzicht();
        updateAdminContent();
        showNotification("Alle informatie is verwijderd.", "success");
      } else {
        showNotification("Verwijderen geannuleerd.", "error");
      }
    }
    
    window.addEventListener("load", () => {
      document.getElementById("barcodeInput").focus();
    });
    
    loadProducts();
    updateDatalist();
    updateOverzicht();
    updateInventoryDisplay();
  </script>
</body>
</html>
